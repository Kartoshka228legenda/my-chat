<!DOCTYPE html>
<html>
<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üí¨ –ß–∞—Ç + –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + –ì—Ä—É–ø–ø—ã + –§–∞–π–ª—ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 10000;
        }

        .auth-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 10px;
            color: #4a00e0;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #4a00e0;
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }

        .auth-button:hover {
            transform: translateY(-2px);
        }

        .auth-switch {
            color: #4a00e0;
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
        }

        /* –í–ö–õ–ê–î–ö–ò */
        .tabs {
            display: none;
            flex: 0 0 auto;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            position: relative;
            z-index: 100;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
            position: relative;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 3px solid white;
        }

        /* –ì–†–£–ü–ü–´ */
        .groups-container {
            display: none;
            flex-direction: column;
            height: calc(100vh - 50px);
            background: white;
        }

        .groups-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9ff;
        }

        .group-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .group-item:hover {
            background: #f5f5ff;
            border-color: #4a00e0;
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .group-members {
            font-size: 12px;
            color: #666;
        }

        .create-group-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(74, 0, 224, 0.3);
            z-index: 1000;
        }

        .create-group-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .create-group-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4a00e0;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
        }

        .modal-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        /* –û–ë–©–ò–ô –ß–ê–¢ */
        .chat-container {
            width: 100%;
            height: calc(100vh - 50px);
            background: white;
            display: none;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            padding: 15px 20px;
            flex-shrink: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-status {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            background: #f8f9ff;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            max-width: 85%;
            clear: both;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.incoming { float: left; }
        .message.outgoing { float: right; }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            position: relative;
        }

        .message.incoming .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            border-top-left-radius: 5px;
        }

        .message.outgoing .message-bubble {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            border-top-right-radius: 5px;
        }

        .message-user {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .message-text {
            font-size: 16px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            text-align: right;
        }

        .input-container {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            background: #f8f9fa;
            min-height: 44px;
            resize: none;
        }

        #messageInput:focus {
            outline: none;
            border-color: #4a00e0;
            background: white;
        }

        .emoji-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .emoji-btn:hover {
            transform: scale(1.1);
        }

        #sendButton {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* –ü–ê–ù–ï–õ–¨ –°–ú–ê–ô–õ–ò–ö–û–í */
        .emoji-panel {
            position: absolute;
            bottom: 70px;
            left: 15px;
            right: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            display: none;
            flex-direction: column;
            max-height: 300px;
            z-index: 1000;
        }

        .emoji-categories {
            display: flex;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            overflow-x: auto;
            margin-bottom: 10px;
        }

        .emoji-category {
            padding: 8px 12px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .emoji-category.active {
            background: #4a00e0;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            overflow-y: auto;
            flex: 1;
        }

        .emoji-item {
            font-size: 24px;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #f0f0f0;
        }

        /* –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø */
        .voice-message {
            padding: 10px;
            background: #f0f4ff;
            border-radius: 20px;
            border: 1px solid #4a00e0;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .voice-player {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-play-btn {
            background: #4a00e0;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-progress {
            flex: 1;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            overflow: hidden;
        }

        .voice-progress-bar {
            height: 100%;
            background: #4a00e0;
            width: 0%;
            transition: width 0.1s linear;
        }

        .voice-duration {
            font-size: 12px;
            color: #666;
            min-width: 40px;
        }

        .voice-record-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .voice-record-btn.recording {
            color: #ff0000;
            animation: pulse 1s infinite;
        }

        .recording-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: #ff0000;
            border-radius: 50%;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }

        /* –§–û–¢–û –°–û–û–ë–©–ï–ù–ò–Ø */
        .photo-message {
            max-width: 250px;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
            border: 1px solid #ddd;
        }

        .photo-message img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* –§–ê–ô–õ–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø */
        .file-message {
            padding: 12px 16px;
            background: #f0f4ff;
            border-radius: 10px;
            border: 1px solid #4a00e0;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 300px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 14px;
            word-break: break-all;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-download {
            background: #4a00e0;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .upload-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-input-hidden {
            display: none;
        }

        .upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #e0e0e0;
            z-index: 3000;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        /* –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø */
        .private-chats-container {
            display: none;
            flex-direction: column;
            height: calc(100vh - 50px);
            background: white;
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9ff;
        }

        .user-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .user-item:hover {
            background: #f5f5ff;
            border-color: #4a00e0;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .private-messages-container {
            display: none;
            flex-direction: column;
            height: calc(100vh - 50px);
            background: white;
        }

        .private-header {
            padding: 15px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* –ù–û–¢–ò–§–ò–ö–ê–¶–ò–ò */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4cd964;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff3b30;
            color: white;
            font-size: 12px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .tab {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .emoji-panel {
                left: 10px;
                right: 10px;
                max-height: 250px;
            }
            
            .photo-message {
                max-width: 200px;
            }
            
            .file-message {
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .voice-message {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .photo-message {
                max-width: 180px;
            }
            
            .auth-box {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h1 class="auth-title">üí¨ –ß–∞—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h1>
            <p class="auth-subtitle">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –æ–±—â–µ–Ω–∏—é!</p>
            
            <div id="loginForm">
                <input type="text" id="loginUsername" class="auth-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                <input type="password" id="loginPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="auth-button" onclick="login()">–í–æ–π—Ç–∏</button>
                <button class="auth-switch" onclick="showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
            
            <div id="registerForm" style="display: none;">
                <input type="text" id="registerUsername" class="auth-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                <input type="password" id="registerPassword" class="auth-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                <input type="password" id="registerConfirm" class="auth-input" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button class="auth-button" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="auth-switch" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ü–†–û–ì–†–ï–°–° –ó–ê–ì–†–£–ó–ö–ò -->
    <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
    </div>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –§–û–¢–û -->
    <div class="photo-modal" id="photoModal">
        <button class="photo-modal-close" onclick="closePhotoModal()">√ó</button>
        <img id="fullPhoto" src="" alt="">
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–û–ó–î–ê–ù–ò–Ø –ì–†–£–ü–ü–´ -->
    <div class="create-group-modal" id="createGroupModal">
        <div class="create-group-box">
            <h2 class="modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <input type="text" id="groupNameInput" class="modal-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <input type="text" id="groupDescInput" class="modal-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeCreateGroupModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="mainInterface" style="display: none;">
        <!-- –í–ö–õ–ê–î–ö–ò -->
        <div class="tabs" id="tabs">
            <div class="tab active" data-tab="groups">
                üë• –ì—Ä—É–ø–ø—ã
                <span class="notification-badge" id="groupsBadge">0</span>
            </div>
            <div class="tab" data-tab="public">
                üí¨ –û–±—â–∏–π —á–∞—Ç
                <span class="notification-badge" id="publicBadge">0</span>
            </div>
            <div class="tab" data-tab="private">
                üë§ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                <span class="notification-badge" id="privateBadge">0</span>
            </div>
        </div>

        <!-- –ì–†–£–ü–ü–´ -->
        <div class="groups-container" id="groupsContainer">
            <div class="header">
                <div class="header-left">
                    <h1>üë• –ì—Ä—É–ø–ø—ã</h1>
                    <div class="online-status">
                        <div class="online-dot"></div>
                        <span id="groupsCount">0</span> –¥–æ—Å—Ç—É–ø–Ω–æ
                    </div>
                </div>
            </div>
            
            <div class="groups-list" id="groupsList">
                <!-- –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <button class="create-group-btn" onclick="openCreateGroupModal()">+</button>
        </div>

        <!-- –û–ë–©–ò–ô –ß–ê–¢ -->
        <div class="chat-container" id="publicChat">
            <div class="header">
                <div class="header-left">
                    <h1 id="currentGroupName">üí¨ –û–±—â–∏–π —á–∞—Ç</h1>
                    <div class="online-status">
                        <div class="online-dot"></div>
                        <span id="onlineCount">1</span> –æ–Ω–ª–∞–π–Ω
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="leaveGroup()" id="leaveGroupBtn" style="display: none;">üö™</button>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages-container" id="messagesContainer">
                <div style="text-align: center; color: #666; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üëã</div>
                    <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —Å–º–∞–π–ª–∏–∫–æ–≤ -->
            <div class="emoji-panel" id="emojiPanel">
                <div class="emoji-categories" id="emojiCategories"></div>
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="input-container">
                <button class="upload-btn" id="fileButton" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
                <input type="file" id="fileInput" class="file-input-hidden" multiple>
                
                <button class="photo-upload-btn upload-btn" id="photoButton" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
                <input type="file" id="photoInput" accept="image/*" class="file-input-hidden" multiple>
                
                <button class="voice-record-btn upload-btn" id="voiceButton" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    üé§
                    <span class="recording-indicator" id="recordingIndicator"></span>
                </button>
                
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button class="emoji-btn" id="emojiButton">üòä</button>
                <button id="sendButton">‚û§</button>
            </div>
        </div>

        <!-- –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø -->
        <div class="private-chats-container" id="privateChats">
            <div class="header">
                <div class="header-left">
                    <h1>üë§ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h1>
                    <div class="online-status">
                        <div class="online-dot"></div>
                        <span id="privateOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω
                    </div>
                </div>
            </div>
            
            <div class="users-list" id="usersList">
                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>

        <!-- –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø - –ß–ê–¢ -->
        <div class="private-messages-container" id="privateMessages">
            <div class="private-header">
                <button class="back-btn" id="backToUsers">‚Üê</button>
                <div style="flex: 1;">
                    <h2 id="privateChatWith">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    <div class="online-status">
                        <div class="online-dot"></div>
                        <span id="privateOnlineStatus">–æ–Ω–ª–∞–π–Ω</span>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="privateMessagesContainer">
                <!-- –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <div class="input-container">
                <button class="upload-btn private-upload-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
                <input type="file" id="privateFileInput" class="file-input-hidden" multiple>
                
                <button class="photo-upload-btn upload-btn private-upload-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
                <input type="file" id="privatePhotoInput" accept="image/*" class="file-input-hidden" multiple>
                
                <button class="voice-record-btn upload-btn private-upload-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    üé§
                    <span class="recording-indicator private-recording-indicator"></span>
                </button>
                
                <input type="text" id="privateMessageInput" placeholder="–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button class="emoji-btn private-emoji-btn">üòä</button>
                <button id="privateSendButton">‚û§</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <script>
        // === –ö–û–ù–§–ò–ì FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDozb-394r3thXXzLdnSE1W-n8-5ts-VLQ",
            authDomain: "chat-66525.firebaseapp.com",
            databaseURL: "https://chat-66525-default-rtdb.firebaseio.com",
            projectId: "chat-66525",
            storageBucket: "chat-66525.firebasestorage.app",
            messagingSenderId: "553583707162",
            appId: "1:553583707162:web:795d742acf5a4ee5fbbda3",
            measurementId: "G-JHSN8XBHZE"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        // ============ –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let currentUser = null;
        let currentPrivateChat = null;
        let currentGroup = null;
        let emojiPanelVisible = false;
        let onlineUsers = {};
        let groups = {};
        let userStatusRef = null;
        
        // –î–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentAudio = null;
        
        // –î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        let unreadPublic = 0;
        let unreadPrivate = 0;
        let unreadGroups = 0;
        
        // ============ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ============
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }
        
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }
        
        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            
            if (!username || username.length < 3) {
                showNotification('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            if (password.length < 6) {
                showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            if (password !== confirm) {
                showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const userRef = database.ref('users/' + username);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            await userRef.set({
                id: userId,
                username: username,
                password: password, // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è!
                createdAt: Date.now()
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏–Ω–∏–º—Å—è
            loginUser(username, password);
        }
        
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            loginUser(username, password);
        }
        
        async function loginUser(username, password) {
            try {
                // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                const userRef = database.ref('users/' + username);
                const snapshot = await userRef.once('value');
                
                if (!snapshot.exists()) {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const userData = snapshot.val();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ!)
                if (userData.password !== password) {
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    return;
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser = {
                    id: userData.id,
                    username: username
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('chat_user', JSON.stringify(currentUser));
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                document.getElementById('tabs').style.display = 'flex';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç
                initChat();
                showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + username + '!');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
        }
        
        function checkAuth() {
            const savedUser = localStorage.getItem('chat_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainInterface').style.display = 'block';
                    document.getElementById('tabs').style.display = 'flex';
                    initChat();
                } catch (e) {
                    localStorage.removeItem('chat_user');
                }
            }
        }
        
        // ============ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }
        
        function updateUnreadBadges() {
            document.getElementById('publicBadge').textContent = unreadPublic > 99 ? '99+' : unreadPublic;
            document.getElementById('publicBadge').style.display = unreadPublic > 0 ? 'flex' : 'none';
            
            document.getElementById('privateBadge').textContent = unreadPrivate > 99 ? '99+' : unreadPrivate;
            document.getElementById('privateBadge').style.display = unreadPrivate > 0 ? 'flex' : 'none';
            
            document.getElementById('groupsBadge').textContent = unreadGroups > 99 ? '99+' : unreadGroups;
            document.getElementById('groupsBadge').style.display = unreadGroups > 0 ? 'flex' : 'none';
        }
        
        // ============ –°–ú–ê–ô–õ–ò–ö–ò ============
        const emojiCategories = [
            { name: "popular", title: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ" },
            { name: "smileys", title: "–≠–º–æ—Ü–∏–∏" },
            { name: "people", title: "–õ—é–¥–∏" },
            { name: "animals", title: "–ñ–∏–≤–æ—Ç–Ω—ã–µ" },
            { name: "food", title: "–ï–¥–∞" },
            { name: "activities", title: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" },
            { name: "travel", title: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è" },
            { name: "objects", title: "–û–±—ä–µ–∫—Ç—ã" },
            { name: "symbols", title: "–°–∏–º–≤–æ–ª—ã" }
        ];
        
        const emojis = {
            popular: [
                "üòÄ", "üòÇ", "ü•∞", "üòé", "üëç", "‚ù§Ô∏è", "üî•", "üéâ", "ü§î", "üëè",
                "üíØ", "‚ú®", "üòä", "üòç", "üò¢", "üò°", "ü§£", "üòú", "üôè", "üí™"
            ],
            smileys: [
                "üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "ü§£", "üòÇ", "üôÇ", "üôÉ",
                "üòâ", "üòä", "üòá", "ü•∞", "üòç", "ü§©", "üòò", "üòó", "üòö", "üòô",
                "üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ë", "ü§ó", "ü§≠", "ü§´", "ü§î",
                "ü§ê", "ü§®", "üòê", "üòë", "üò∂", "üòè", "üòí", "üôÑ", "üò¨", "ü§•"
            ],
            people: [
                "üë∂", "üßí", "üë¶", "üëß", "üßë", "üë®", "üë©", "üßî", "üë®‚Äçü¶∞", "üë©‚Äçü¶∞",
                "üë®‚Äçü¶±", "üë©‚Äçü¶±", "üë®‚Äçü¶≥", "üë©‚Äçü¶≥", "üë®‚Äçü¶≤", "üë©‚Äçü¶≤", "üë±", "üë±‚Äç‚ôÇÔ∏è", "üë±‚Äç‚ôÄÔ∏è", "üßì"
            ],
            animals: [
                "üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ",
                "ü¶Å", "üêÆ", "üê∑", "üêΩ", "üê∏", "üêµ", "üôà", "üôâ", "üôä", "üêí"
            ],
            food: [
                "üçè", "üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "ü´ê",
                "üçà", "üçí", "üçë", "ü•≠", "üçç", "ü••", "ü•ù", "üçÖ", "üçÜ", "ü•ë"
            ],
            activities: [
                "‚öΩ", "üèÄ", "üèà", "‚öæ", "ü•é", "üéæ", "üèê", "üèâ", "ü•è", "üé±",
                "ü™Ä", "üèì", "üè∏", "üèí", "üèë", "ü•ç", "üèè", "ü™É", "ü•Ö", "‚õ≥"
            ],
            travel: [
                "üöó", "üöï", "üöô", "üöå", "üöé", "üèéÔ∏è", "üöì", "üöë", "üöí", "üöê",
                "üõª", "üöö", "üöõ", "üöú", "ü¶Ø", "ü¶Ω", "ü¶º", "üõ¥", "üö≤", "üõµ"
            ],
            objects: [
                "üíé", "üî™", "üè∫", "üóø", "ü™ô", "üí∞", "üí¥", "üíµ", "üí∂", "üí∑",
                "üí∏", "üí≥", "üßæ", "‚úâÔ∏è", "üìß", "üì®", "üì©", "üì§", "üì•", "üì¶"
            ],
            symbols: [
                "‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî",
                "‚ù£Ô∏è", "üíï", "üíû", "üíì", "üíó", "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è"
            ]
        };
        
        function initEmojiPanel() {
            const categoriesContainer = document.getElementById('emojiCategories');
            const gridContainer = document.getElementById('emojiGrid');
            
            emojiCategories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'emoji-category';
                btn.textContent = category.title;
                btn.dataset.category = category.name;
                btn.addEventListener('click', () => showEmojiCategory(category.name));
                categoriesContainer.appendChild(btn);
            });
            
            showEmojiCategory('popular');
            
            document.getElementById('emojiButton').addEventListener('click', toggleEmojiPanel);
            document.querySelector('.private-emoji-btn').addEventListener('click', toggleEmojiPanel);
            
            document.addEventListener('click', (e) => {
                const emojiPanel = document.getElementById('emojiPanel');
                const emojiBtn = document.getElementById('emojiButton');
                const privateEmojiBtn = document.querySelector('.private-emoji-btn');
                
                if (emojiPanel.style.display === 'flex' && 
                    !emojiPanel.contains(e.target) && 
                    !emojiBtn.contains(e.target) &&
                    !privateEmojiBtn.contains(e.target)) {
                    emojiPanel.style.display = 'none';
                    emojiPanelVisible = false;
                }
            });
        }
        
        function showEmojiCategory(categoryName) {
            const gridContainer = document.getElementById('emojiGrid');
            const categoryButtons = document.querySelectorAll('.emoji-category');
            
            categoryButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === categoryName);
            });
            
            gridContainer.innerHTML = '';
            
            emojis[categoryName].forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => insertEmoji(emoji));
                gridContainer.appendChild(emojiItem);
            });
        }
        
        function toggleEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanelVisible = !emojiPanelVisible;
            emojiPanel.style.display = emojiPanelVisible ? 'flex' : 'none';
        }
        
        function insertEmoji(emoji) {
            const activeInput = currentPrivateChat ? 
                document.getElementById('privateMessageInput') : 
                document.getElementById('messageInput');
            
            const start = activeInput.selectionStart;
            const end = activeInput.selectionEnd;
            const text = activeInput.value;
            
            activeInput.value = text.substring(0, start) + emoji + text.substring(end);
            activeInput.focus();
            activeInput.selectionStart = activeInput.selectionEnd = start + emoji.length;
        }
        
        // ============ –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ============
        function initVoiceMessages() {
            const voiceButton = document.getElementById('voiceButton');
            const privateVoiceButton = document.querySelector('.private-voice-btn');
            
            voiceButton.addEventListener('mousedown', startRecording);
            voiceButton.addEventListener('mouseup', stopRecording);
            voiceButton.addEventListener('mouseleave', stopRecording);
            
            privateVoiceButton.addEventListener('mousedown', startRecording);
            privateVoiceButton.addEventListener('mouseup', stopRecording);
            privateVoiceButton.addEventListener('mouseleave', stopRecording);
            
            voiceButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startRecording();
            });
            
            voiceButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopRecording();
            });
            
            privateVoiceButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startRecording();
            });
            
            privateVoiceButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopRecording();
            });
        }
        
        async function startRecording() {
            try {
                showNotification('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    if (audioChunks.length === 0) {
                        showNotification('–ó–∞–ø–∏—Å—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è');
                        return;
                    }
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    if (audioBlob.size < 1000) {
                        showNotification('–ó–∞–ø–∏—Å—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è');
                        return;
                    }
                    
                    await uploadAndSendVoiceMessage(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', event.error);
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏');
                };
                
                mediaRecorder.start(100);
                isRecording = true;
                
                document.getElementById('voiceButton').classList.add('recording');
                document.getElementById('recordingIndicator').classList.add('active');
                document.querySelector('.private-voice-btn').classList.add('recording');
                document.querySelector('.private-recording-indicator').classList.add('active');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                try {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    document.getElementById('voiceButton').classList.remove('recording');
                    document.getElementById('recordingIndicator').classList.remove('active');
                    document.querySelector('.private-voice-btn').classList.remove('recording');
                    document.querySelector('.private-recording-indicator').classList.remove('active');
                    
                    showNotification('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å...');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏:', error);
                }
            }
        }
        
        async function uploadAndSendVoiceMessage(audioBlob) {
            try {
                showUploadProgress(0);
                
                const fileName = `voice_${currentUser.id}_${Date.now()}.webm`;
                const storageRef = storage.ref(`voice_messages/${fileName}`);
                
                const uploadTask = storageRef.put(audioBlob);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        showUploadProgress(progress);
                    },
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', error);
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ');
                        hideUploadProgress();
                    },
                    async () => {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        const message = {
                            type: 'voice',
                            url: downloadURL,
                            duration: Math.round(audioBlob.size / 16000),
                            user: currentUser.username,
                            userId: currentUser.id,
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            timestamp: Date.now()
                        };
                        
                        if (currentPrivateChat) {
                            const chatId = getChatId(currentUser.id, currentPrivateChat);
                            message.to = currentPrivateChat;
                            message.from = currentUser.id;
                            await database.ref('private_messages/' + chatId).push(message);
                        } else if (currentGroup) {
                            message.groupId = currentGroup;
                            await database.ref('group_messages/' + currentGroup).push(message);
                        } else {
                            await database.ref('messages/public').push(message);
                        }
                        
                        hideUploadProgress();
                        showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    }
                );
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
                hideUploadProgress();
            }
        }
        
        function createVoiceMessageElement(message) {
            const voiceDiv = document.createElement('div');
            voiceDiv.className = 'voice-message';
            
            voiceDiv.innerHTML = `
                <div class="voice-player">
                    <button class="voice-play-btn" onclick="playVoiceMessage('${message.url}', this)">‚ñ∂Ô∏è</button>
                    <div class="voice-progress">
                        <div class="voice-progress-bar"></div>
                    </div>
                    <div class="voice-duration">${message.duration || '1'}—Å</div>
                </div>
                <div style="font-size: 12px; color: #666;">
                    ${message.user}
                </div>
            `;
            
            return voiceDiv;
        }
        
        function playVoiceMessage(url, button) {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio = null;
                button.innerHTML = '‚ñ∂Ô∏è';
                return;
            }
            
            currentAudio = new Audio(url);
            const progressBar = button.parentElement.querySelector('.voice-progress-bar');
            
            currentAudio.addEventListener('loadedmetadata', () => {
                progressBar.style.width = '0%';
            });
            
            currentAudio.addEventListener('timeupdate', () => {
                if (currentAudio.duration > 0) {
                    const percent = (currentAudio.currentTime / currentAudio.duration) * 100;
                    progressBar.style.width = percent + '%';
                }
            });
            
            currentAudio.addEventListener('ended', () => {
                button.innerHTML = '‚ñ∂Ô∏è';
                progressBar.style.width = '0%';
                currentAudio = null;
            });
            
            currentAudio.addEventListener('error', () => {
                showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ');
                button.innerHTML = '‚ñ∂Ô∏è';
                progressBar.style.width = '0%';
                currentAudio = null;
            });
            
            currentAudio.play()
                .then(() => {
                    button.innerHTML = '‚è∏Ô∏è';
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ');
                });
        }
        
        // ============ –§–ê–ô–õ–´ –ò –§–û–¢–û ============
        function initFileUpload() {
            const fileButton = document.getElementById('fileButton');
            const privateFileButton = document.querySelector('.private-upload-btn');
            const fileInput = document.getElementById('fileInput');
            const privateFileInput = document.getElementById('privateFileInput');
            const photoButton = document.getElementById('photoButton');
            const privatePhotoButton = document.querySelector('.private-photo-btn');
            const photoInput = document.getElementById('photoInput');
            const privatePhotoInput = document.getElementById('privatePhotoInput');
            
            fileButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            privateFileButton.addEventListener('click', () => {
                privateFileInput.click();
            });
            
            photoButton.addEventListener('click', () => {
                photoInput.click();
            });
            
            privatePhotoButton.addEventListener('click', () => {
                privatePhotoInput.click();
            });
            
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    await handleFileUpload(file);
                }
                fileInput.value = '';
            });
            
            privateFileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    await handleFileUpload(file);
                }
                privateFileInput.value = '';
            });
            
            photoInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    await handleFileUpload(file, true);
                }
                photoInput.value = '';
            });
            
            privatePhotoInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    await handleFileUpload(file, true);
                }
                privatePhotoInput.value = '';
            });
        }
        
        async function handleFileUpload(file, isImage = false) {
            if (!file) return;
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ 50MB');
                return;
            }
            
            if (isImage && !file.type.startsWith('image/')) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }
            
            await uploadAndSendFile(file, isImage);
        }
        
        async function uploadAndSendFile(file, isImage = false) {
            try {
                showUploadProgress(0);
                
                const fileName = `${isImage ? 'photo' : 'file'}_${currentUser.id}_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const folder = isImage ? 'photos' : 'files';
                const storageRef = storage.ref(`${folder}/${fileName}`);
                
                const uploadTask = storageRef.put(file);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        showUploadProgress(progress);
                    },
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                        hideUploadProgress();
                    },
                    async () => {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        let thumbURL = null;
                        if (isImage) {
                            thumbURL = await createThumbnail(file);
                        }
                        
                        const message = {
                            type: isImage ? 'photo' : 'file',
                            url: downloadURL,
                            thumbnail: thumbURL,
                            fileName: file.name,
                            fileSize: formatFileSize(file.size),
                            fileType: file.type,
                            user: currentUser.username,
                            userId: currentUser.id,
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            timestamp: Date.now()
                        };
                        
                        if (currentPrivateChat) {
                            const chatId = getChatId(currentUser.id, currentPrivateChat);
                            message.to = currentPrivateChat;
                            message.from = currentUser.id;
                            await database.ref('private_messages/' + chatId).push(message);
                        } else if (currentGroup) {
                            message.groupId = currentGroup;
                            await database.ref('group_messages/' + currentGroup).push(message);
                        } else {
                            await database.ref('messages/public').push(message);
                        }
                        
                        hideUploadProgress();
                        showNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                    }
                );
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
                hideUploadProgress();
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function createThumbnail(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxSize = 200;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function createPhotoMessageElement(message) {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-message';
            
            photoDiv.innerHTML = `
                <img src="${message.thumbnail || message.url}" 
                     onclick="openFullPhoto('${message.url}')" 
                     style="cursor: pointer;"
                     loading="lazy"
                     onerror="this.src='${message.url}'">
                <div style="padding: 8px; font-size: 12px; color: #666;">
                    <div>${message.user}</div>
                    <div>${message.fileSize || ''}</div>
                </div>
            `;
            
            return photoDiv;
        }
        
        function createFileMessageElement(message) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-message';
            
            const fileIcon = getFileIcon(message.fileType);
            
            fileDiv.innerHTML = `
                <div class="file-icon">${fileIcon}</div>
                <div class="file-info">
                    <div class="file-name">${message.fileName}</div>
                    <div class="file-size">${message.fileSize}</div>
                </div>
                <a href="${message.url}" download="${message.fileName}" class="file-download" title="–°–∫–∞—á–∞—Ç—å">‚Üì</a>
            `;
            
            return fileDiv;
        }
        
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            if (fileType.includes('pdf')) return 'üìï';
            if (fileType.includes('word') || fileType.includes('document')) return 'üìÑ';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'üìë';
            if (fileType.includes('audio')) return 'üéµ';
            if (fileType.includes('video')) return 'üé¨';
            if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('archive')) return 'üóúÔ∏è';
            return 'üìÅ';
        }
        
        function openFullPhoto(url) {
            document.getElementById('fullPhoto').src = url;
            document.getElementById('photoModal').style.display = 'flex';
        }
        
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        function showUploadProgress(percent) {
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadProgressBar').style.width = percent + '%';
        }
        
        function hideUploadProgress() {
            setTimeout(() => {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadProgressBar').style.width = '0%';
            }, 500);
        }
        
        // ============ –ì–†–£–ü–ü–´ ============
        function openCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'flex';
            document.getElementById('groupNameInput').focus();
        }
        
        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupDescInput').value = '';
        }
        
        async function createGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            const description = document.getElementById('groupDescInput').value.trim();
            
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            if (name.length < 3) {
                showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            const groupId = 'group_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            await database.ref('groups/' + groupId).set({
                id: groupId,
                name: name,
                description: description || '',
                creator: currentUser.id,
                creatorName: currentUser.username,
                createdAt: Date.now(),
                members: {
                    [currentUser.id]: true
                }
            });
            
            closeCreateGroupModal();
            showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞!');
            loadGroups();
        }
        
        async function loadGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</div>';
            
            database.ref('groups').on('value', (snapshot) => {
                groups = snapshot.val() || {};
                groupsList.innerHTML = '';
                
                let groupsCount = 0;
                
                Object.entries(groups).forEach(([groupId, group]) => {
                    if (group.members && group.members[currentUser.id]) {
                        groupsCount++;
                        
                        const groupItem = document.createElement('div');
                        groupItem.className = 'group-item';
                        groupItem.dataset.groupId = groupId;
                        
                        const firstLetter = group.name.charAt(0).toUpperCase();
                        
                        groupItem.innerHTML = `
                            <div class="group-avatar">${firstLetter}</div>
                            <div class="group-info">
                                <div class="group-name">${group.name}</div>
                                <div class="group-members">${group.description || '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç'}</div>
                            </div>
                        `;
                        
                        groupItem.addEventListener('click', () => openGroupChat(groupId, group.name));
                        groupsList.appendChild(groupItem);
                    }
                });
                
                document.getElementById('groupsCount').textContent = groupsCount;
                
                if (groupsCount === 0) {
                    groupsList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üë•</div>
                            <h3>–ù–µ—Ç –≥—Ä—É–ø–ø</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É</p>
                        </div>
                    `;
                }
            });
        }
        
        function openGroupChat(groupId, groupName) {
            currentGroup = groupId;
            currentPrivateChat = null;
            
            document.getElementById('groupsContainer').style.display = 'none';
            document.getElementById('publicChat').style.display = 'flex';
            document.getElementById('privateMessages').style.display = 'none';
            
            document.getElementById('currentGroupName').textContent = 'üë• ' + groupName;
            document.getElementById('leaveGroupBtn').style.display = 'block';
            
            loadGroupMessages(groupId);
        }
        
        function leaveGroup() {
            if (!currentGroup) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É?')) {
                database.ref('groups/' + currentGroup + '/members/' + currentUser.id).remove();
                currentGroup = null;
                
                document.getElementById('leaveGroupBtn').style.display = 'none';
                document.getElementById('currentGroupName').textContent = 'üí¨ –û–±—â–∏–π —á–∞—Ç';
                
                showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É');
                loadGroups();
            }
        }
        
        function loadGroupMessages(groupId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            database.ref('group_messages/' + groupId).limitToLast(100).on('child_added', (snapshot) => {
                addMessageToUI(snapshot.val(), 'group');
            });
        }
        
        // ============ –û–ë–©–ò–ô –ß–ê–¢ –ò –ì–†–£–ü–ü–´ ============
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            const message = {
                text: messageText,
                user: currentUser.username,
                userId: currentUser.id,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'text'
            };
            
            if (currentGroup) {
                message.groupId = currentGroup;
                database.ref('group_messages/' + currentGroup).push(message);
            } else {
                database.ref('messages/public').push(message);
            }
            
            messageInput.value = '';
            messageInput.focus();
            
            document.getElementById('emojiPanel').style.display = 'none';
            emojiPanelVisible = false;
        }
        
        function addMessageToUI(message, type = 'public') {
            const container = document.getElementById(type === 'private' ? 'privateMessagesContainer' : 'messagesContainer');
            
            const welcomeMsg = container.querySelector('div[style*="text-align: center"]');
            if (welcomeMsg) welcomeMsg.remove();
            
            const messageDiv = document.createElement('div');
            const isOurMessage = message.userId === currentUser.id;
            
            messageDiv.className = `message ${isOurMessage ? 'outgoing' : 'incoming'}`;
            
            let content = '';
            
            if (message.type === 'voice') {
                content = createVoiceMessageElement(message).outerHTML;
            } else if (message.type === 'photo') {
                content = createPhotoMessageElement(message).outerHTML;
            } else if (message.type === 'file') {
                content = createFileMessageElement(message).outerHTML;
            } else {
                content = `
                    <div class="message-bubble">
                        <div class="message-user">
                            ${isOurMessage ? '–í—ã' : message.user}
                        </div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${message.time}</div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
            
            if (!isOurMessage && document.hidden) {
                if (type === 'public' || type === 'group') {
                    unreadPublic++;
                } else if (type === 'private') {
                    unreadPrivate++;
                }
                updateUnreadBadges();
            }
        }
        
        // ============ –õ–ò–ß–ù–´–ï –ß–ê–¢–´ ============
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
            
            let onlineCount = 0;
            
            database.ref('users').on('value', (usersSnapshot) => {
                const allUsers = usersSnapshot.val() || {};
                usersList.innerHTML = '';
                
                Object.entries(allUsers).forEach(([username, userData]) => {
                    if (username === currentUser.username) return;
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.dataset.userId = userData.id;
                    
                    const firstLetter = username.charAt(0).toUpperCase();
                    
                    userItem.innerHTML = `
                        <div class="user-avatar">${firstLetter}</div>
                        <div class="user-info">
                            <div class="user-name">${username}</div>
                            <div class="user-status">
                                <span class="online-dot" style="width: 6px; height: 6px; background: #999"></span>
                                –æ—Ñ—Ñ–ª–∞–π–Ω
                            </div>
                        </div>
                    `;
                    
                    userItem.addEventListener('click', () => openPrivateChat(userData.id, username));
                    usersList.appendChild(userItem);
                });
                
                document.getElementById('privateOnlineCount').textContent = onlineCount;
                
                if (Object.keys(allUsers).length <= 1) {
                    usersList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üë§</div>
                            <h3>–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                            <p>–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</p>
                        </div>
                    `;
                }
            });
        }
        
        function openPrivateChat(otherUserId, otherUserName) {
            currentPrivateChat = otherUserId;
            currentGroup = null;
            
            document.getElementById('privateChats').style.display = 'none';
            document.getElementById('privateMessages').style.display = 'flex';
            
            document.getElementById('privateChatWith').textContent = otherUserName;
            
            loadPrivateMessages(otherUserId);
            
            document.getElementById('privateMessageInput').focus();
            
            unreadPrivate = 0;
            updateUnreadBadges();
        }
        
        function loadPrivateMessages(otherUserId) {
            const chatId = getChatId(currentUser.id, otherUserId);
            const container = document.getElementById('privateMessagesContainer');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            database.ref('private_messages/' + chatId).limitToLast(100).on('child_added', (snapshot) => {
                addMessageToUI(snapshot.val(), 'private');
            });
        }
        
        function sendPrivateMessage() {
            if (!currentPrivateChat) return;
            
            const input = document.getElementById('privateMessageInput');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            const chatId = getChatId(currentUser.id, currentPrivateChat);
            const message = {
                text: messageText,
                from: currentUser.id,
                to: currentPrivateChat,
                fromName: currentUser.username,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'text'
            };
            
            database.ref('private_messages/' + chatId).push(message);
            input.value = '';
            input.focus();
            
            document.getElementById('emojiPanel').style.display = 'none';
            emojiPanelVisible = false;
        }
        
        function getChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }
        
        // ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–ê–î–ö–ê–ú–ò ============
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    if (tabName === 'public') {
                        unreadPublic = 0;
                    } else if (tabName === 'private') {
                        unreadPrivate = 0;
                    } else if (tabName === 'groups') {
                        unreadGroups = 0;
                    }
                    updateUnreadBadges();
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.getElementById('publicChat').style.display = 'none';
                    document.getElementById('privateChats').style.display = 'none';
                    document.getElementById('privateMessages').style.display = 'none';
                    document.getElementById('groupsContainer').style.display = 'none';
                    
                    if (tabName === 'public') {
                        document.getElementById('publicChat').style.display = 'flex';
                        if (currentGroup) {
                            document.getElementById('currentGroupName').textContent = 'üë• ' + groups[currentGroup]?.name || '–ì—Ä—É–ø–ø–∞';
                            document.getElementById('leaveGroupBtn').style.display = 'block';
                        } else {
                            document.getElementById('currentGroupName').textContent = 'üí¨ –û–±—â–∏–π —á–∞—Ç';
                            document.getElementById('leaveGroupBtn').style.display = 'none';
                        }
                    } else if (tabName === 'private') {
                        document.getElementById('privateChats').style.display = 'flex';
                        loadUsersList();
                    } else if (tabName === 'groups') {
                        document.getElementById('groupsContainer').style.display = 'flex';
                        loadGroups();
                    }
                    
                    currentPrivateChat = null;
                    
                    document.getElementById('emojiPanel').style.display = 'none';
                    emojiPanelVisible = false;
                });
            });
            
            document.getElementById('backToUsers').addEventListener('click', () => {
                document.getElementById('privateMessages').style.display = 'none';
                document.getElementById('privateChats').style.display = 'flex';
                currentPrivateChat = null;
            });
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        function initChat() {
            initEmojiPanel();
            initTabs();
            initVoiceMessages();
            initFileUpload();
            
            userStatusRef = database.ref('online_users/' + currentUser.id);
            
            userStatusRef.set({
                username: currentUser.username,
                online: true,
                lastSeen: Date.now()
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            database.ref('online_users').on('value', (snapshot) => {
                onlineUsers = snapshot.val() || {};
                
                let onlineCount = 0;
                Object.values(onlineUsers).forEach(user => {
                    if (user.online && (Date.now() - user.lastSeen < 30000)) {
                        onlineCount++;
                    }
                });
                document.getElementById('onlineCount').textContent = onlineCount;
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            database.ref('messages/public').limitToLast(100).on('child_added', (snapshot) => {
                addMessageToUI(snapshot.val());
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã
            loadGroups();
            
            // –°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('privateSendButton').addEventListener('click', sendPrivateMessage);
            document.getElementById('privateMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
            setInterval(() => {
                if (userStatusRef) {
                    userStatusRef.update({ lastSeen: Date.now() });
                }
            }, 10000);
            
            // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                if (userStatusRef) {
                    userStatusRef.update({ online: false });
                }
            });
            
            // –ü—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏/–ø–æ–∫–∞–∑–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (userStatusRef) {
                        userStatusRef.update({ lastSeen: Date.now() });
                    }
                } else {
                    if (userStatusRef) {
                        userStatusRef.update({ online: true, lastSeen: Date.now() });
                    }
                    unreadPublic = 0;
                    unreadPrivate = 0;
                    unreadGroups = 0;
                    updateUnreadBadges();
                }
            });
            
            document.getElementById('messageInput').focus();
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>