<!DOCTYPE html>
<html>
<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üí¨ –ß–∞—Ç + –°–º–∞–π–ª–∏–∫–∏ + –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è + –§–æ—Ç–æ + –ì–æ–ª–æ—Å–æ–≤—ã–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* –í–ö–õ–ê–î–ö–ò */
        .tabs {
            display: flex;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            position: relative;
            z-index: 100;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
            position: relative;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 3px solid white;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff3b30;
            color: white;
            font-size: 12px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* –ü–û–ò–°–ö */
        .search-container {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: none;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a00e0;
        }

        .close-search {
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
        }

        /* –û–ë–©–ò–ô –ß–ê–¢ */
        .chat-container {
            width: 100%;
            height: calc(100vh - 50px);
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            padding: 15px 20px;
            flex-shrink: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-status {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            background: #f8f9ff;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            max-width: 85%;
            clear: both;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.incoming { float: left; }
        .message.outgoing { float: right; }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            position: relative;
        }

        .message.incoming .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            border-top-left-radius: 5px;
        }

        .message.outgoing .message-bubble {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            border-top-right-radius: 5px;
        }

        .message-user {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .message-text {
            font-size: 16px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            text-align: right;
        }

        .message.search-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            border-radius: 10px;
            padding: 2px 5px;
        }

        .input-container {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        #nameInput {
            width: 80px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            background: #f8f9fa;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            background: #f8f9fa;
            min-height: 44px;
            resize: none;
        }

        #messageInput:focus {
            outline: none;
            border-color: #4a00e0;
            background: white;
        }

        .emoji-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .emoji-btn:hover {
            transform: scale(1.1);
        }

        #sendButton {
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* –ü–ê–ù–ï–õ–¨ –°–ú–ê–ô–õ–ò–ö–û–í */
        .emoji-panel {
            position: absolute;
            bottom: 70px;
            left: 15px;
            right: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            display: none;
            flex-direction: column;
            max-height: 300px;
            z-index: 1000;
        }

        .emoji-categories {
            display: flex;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            overflow-x: auto;
            margin-bottom: 10px;
        }

        .emoji-category {
            padding: 8px 12px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .emoji-category.active {
            background: #4a00e0;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            overflow-y: auto;
            flex: 1;
        }

        .emoji-item {
            font-size: 24px;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #f0f0f0;
        }

        /* –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø */
        .voice-message {
            padding: 10px;
            background: #f0f4ff;
            border-radius: 20px;
            border: 1px solid #4a00e0;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .voice-player {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-play-btn {
            background: #4a00e0;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-progress {
            flex: 1;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            overflow: hidden;
        }

        .voice-progress-bar {
            height: 100%;
            background: #4a00e0;
            width: 0%;
            transition: width 0.1s linear;
        }

        .voice-duration {
            font-size: 12px;
            color: #666;
            min-width: 40px;
        }

        .voice-record-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .voice-record-btn.recording {
            color: #ff0000;
            animation: pulse 1s infinite;
        }

        .recording-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: #ff0000;
            border-radius: 50%;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }

        /* –§–û–¢–û –°–û–û–ë–©–ï–ù–ò–Ø */
        .photo-message {
            max-width: 250px;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
            border: 1px solid #ddd;
        }

        .photo-message img {
            width: 100%;
            height: auto;
            display: block;
        }

        .photo-upload-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-input-hidden {
            display: none;
        }

        /* –†–ï–ê–ö–¶–ò–ò */
        .message-reactions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            background: rgba(74, 0, 224, 0.1);
            border-color: #4a00e0;
        }

        .reaction-btn.active {
            background: rgba(74, 0, 224, 0.2);
            border-color: #4a00e0;
        }

        .reaction-count {
            font-size: 11px;
            color: #666;
        }

        .add-reaction-btn {
            background: transparent;
            border: 1px dashed #ddd;
            border-radius: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        .reaction-picker {
            position: absolute;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 10px;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            z-index: 1001;
            max-height: 200px;
            overflow-y: auto;
        }

        .reaction-emoji {
            font-size: 20px;
            padding: 5px;
            cursor: pointer;
            text-align: center;
            border-radius: 5px;
        }

        .reaction-emoji:hover {
            background: #f0f0f0;
        }

        /* –õ–ò–ß–ù–´–ï –ß–ê–¢–´ */
        .private-chats-container {
            display: none;
            flex-direction: column;
            height: calc(100vh - 50px);
            background: white;
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9ff;
        }

        .user-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .user-item:hover {
            background: #f5f5ff;
            border-color: #4a00e0;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .private-messages-container {
            display: none;
            flex-direction: column;
            height: calc(100vh - 50px);
            background: white;
        }

        .private-header {
            padding: 15px;
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .tab {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .emoji-panel {
                left: 10px;
                right: 10px;
                max-height: 250px;
            }
            
            .photo-message {
                max-width: 200px;
            }
        }

        @media (max-width: 480px) {
            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            #nameInput {
                width: 60px;
                font-size: 12px;
                padding: 8px 10px;
            }
            
            .voice-message {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .photo-message {
                max-width: 180px;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4cd964;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .search-result-highlight {
            background-color: #fffacd;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ -->
    <div class="photo-modal" id="photoModal">
        <button class="photo-modal-close" onclick="closePhotoModal()">√ó</button>
        <img id="fullPhoto" src="" alt="">
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div class="tabs">
        <div class="tab active" data-tab="public">
            üí¨ –û–±—â–∏–π —á–∞—Ç
            <span class="notification-badge" id="publicBadge">0</span>
        </div>
        <div class="tab" data-tab="private">
            üë• –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            <span class="notification-badge" id="privateBadge">0</span>
        </div>
    </div>

    <!-- –ü–û–ò–°–ö -->
    <div class="search-container" id="searchContainer">
        <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π...">
        <button class="close-search" id="closeSearch">‚úï</button>
    </div>

    <!-- –û–ë–©–ò–ô –ß–ê–¢ -->
    <div class="chat-container" id="publicChat">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="header-left">
                <h1>
                    üí¨ –û–±—â–∏–π —á–∞—Ç
                </h1>
                <div class="online-status">
                    <div class="online-dot"></div>
                    <span id="onlineCount">1</span> –æ–Ω–ª–∞–π–Ω
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="searchPublicBtn" title="–ü–æ–∏—Å–∫">üîç</button>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="messages-container" id="messagesContainer">
            <div style="text-align: center; color: #666; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üëã</div>
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                <p>–≠—Ç–æ –æ–±—â–∏–π —á–∞—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —Å–º–∞–π–ª–∏–∫–æ–≤ -->
        <div class="emoji-panel" id="emojiPanel">
            <div class="emoji-categories" id="emojiCategories"></div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
        <div class="input-container">
            <input type="text" id="nameInput" placeholder="–ò–º—è" value="–ì–æ—Å—Ç—å" maxlength="20">
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –º–µ–¥–∏–∞ -->
            <button class="photo-upload-btn" id="photoButton" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
            <input type="file" id="photoInput" accept="image/*" class="file-input-hidden">
            
            <button class="voice-record-btn" id="voiceButton" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                üé§
                <span class="recording-indicator" id="recordingIndicator"></span>
            </button>
            
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button class="emoji-btn" id="emojiButton">üòä</button>
            <button id="sendButton">‚û§</button>
        </div>
    </div>

    <!-- –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø - –°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -->
    <div class="private-chats-container" id="privateChats">
        <div class="header">
            <div class="header-left">
                <h1>üë• –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h1>
                <div class="online-status">
                    <div class="online-dot"></div>
                    <span id="privateOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="searchUsersBtn" title="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">üîç</button>
            </div>
        </div>
        
        <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="search-container" id="usersSearchContainer">
            <input type="text" class="search-input" id="searchUsersInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
            <button class="close-search" id="closeUsersSearch">‚úï</button>
        </div>
        
        <div class="users-list" id="usersList">
            <div style="text-align: center; color: #666; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üë§</div>
                <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</h3>
                <p>–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤—Å–µ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>
            </div>
        </div>
    </div>

    <!-- –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø - –ß–ê–¢ –° –ö–û–ù–ö–†–ï–¢–ù–´–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ú -->
    <div class="private-messages-container" id="privateMessages">
        <div class="private-header">
            <button class="back-btn" id="backToUsers">‚Üê</button>
            <div style="flex: 1;">
                <h2 id="privateChatWith">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <div class="online-status">
                    <div class="online-dot"></div>
                    <span id="privateOnlineStatus">–æ–Ω–ª–∞–π–Ω</span>
                </div>
            </div>
            <button class="header-btn" id="searchPrivateBtn" title="–ü–æ–∏—Å–∫ –≤ –¥–∏–∞–ª–æ–≥–µ">üîç</button>
        </div>
        
        <!-- –ü–æ–∏—Å–∫ –≤ –¥–∏–∞–ª–æ–≥–µ -->
        <div class="search-container" id="privateSearchContainer">
            <input type="text" class="search-input" id="searchPrivateInput" placeholder="–ü–æ–∏—Å–∫ –≤ –¥–∏–∞–ª–æ–≥–µ...">
            <button class="close-search" id="closePrivateSearch">‚úï</button>
        </div>
        
        <div class="messages-container" id="privateMessagesContainer">
            <!-- –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div class="input-container">
            <input type="text" id="privateMessageInput" placeholder="–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button class="photo-upload-btn private-photo-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
            <button class="voice-record-btn private-voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                üé§
                <span class="recording-indicator private-recording-indicator"></span>
            </button>
            <button class="emoji-btn private-emoji-btn">üòä</button>
            <button id="privateSendButton">‚û§</button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–∞–∫—Ü–∏–π -->
    <div class="reaction-picker" id="reactionPicker"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <script>
        // === –ö–û–ù–§–ò–ì FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDozb-394r3thXXzLdnSE1W-n8-5ts-VLQ",
            authDomain: "chat-66525.firebaseapp.com",
            databaseURL: "https://chat-66525-default-rtdb.firebaseio.com",
            projectId: "chat-66525",
            storageBucket: "chat-66525.firebasestorage.app",
            messagingSenderId: "553583707162",
            appId: "1:553583707162:web:795d742acf5a4ee5fbbda3",
            measurementId: "G-JHSN8XBHZE"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        // ============ –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let userName = localStorage.getItem('chat_name') || '–ì–æ—Å—Ç—å' + Math.floor(Math.random() * 1000);
        let userId = localStorage.getItem('chat_user_id');
        let currentPrivateChat = null;
        let emojiPanelVisible = false;
        let onlineUsers = {};
        let userStatusRef = null;
        let isSearching = false;
        let searchQuery = '';
        
        // –î–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentAudio = null;
        
        // –î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        let unreadPublic = 0;
        let unreadPrivate = 0;
        
        // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞
        let allPublicMessages = [];
        let allPrivateMessages = {};
        let currentPrivateMessages = [];
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω–µ—Ç
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chat_user_id', userId);
        }
        
        // ============ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        
        function updateUserName() {
            const newName = document.getElementById('nameInput').value.trim() || '–ì–æ—Å—Ç—å';
            if (newName !== userName) {
                userName = newName;
                localStorage.setItem('chat_name', userName);
                updateUserInfo();
                showNotification('–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ' + userName);
            }
        }
        
        function updateUserInfo() {
            if (userStatusRef) {
                userStatusRef.update({ 
                    name: userName,
                    lastSeen: Date.now()
                });
            }
        }
        
        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }
        
        function updateUnreadBadges() {
            document.getElementById('publicBadge').textContent = unreadPublic > 99 ? '99+' : unreadPublic;
            document.getElementById('publicBadge').style.display = unreadPublic > 0 ? 'flex' : 'none';
            
            document.getElementById('privateBadge').textContent = unreadPrivate > 99 ? '99+' : unreadPrivate;
            document.getElementById('privateBadge').style.display = unreadPrivate > 0 ? 'flex' : 'none';
        }
        
        // ============ –°–ú–ê–ô–õ–ò–ö–ò ============
        const emojiCategories = [
            { name: "popular", title: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ" },
            { name: "smileys", title: "–≠–º–æ—Ü–∏–∏" },
            { name: "people", title: "–õ—é–¥–∏" },
            { name: "animals", title: "–ñ–∏–≤–æ—Ç–Ω—ã–µ" },
            { name: "food", title: "–ï–¥–∞" },
            { name: "activities", title: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" },
            { name: "travel", title: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è" },
            { name: "objects", title: "–û–±—ä–µ–∫—Ç—ã" },
            { name: "symbols", title: "–°–∏–º–≤–æ–ª—ã" },
            { name: "flags", title: "–§–ª–∞–≥–∏" }
        ];
        
        const emojis = {
            popular: [
                "üòÄ", "üòÇ", "ü•∞", "üòé", "üëç", "‚ù§Ô∏è", "üî•", "üéâ", "ü§î", "üëè",
                "üíØ", "‚ú®", "üòä", "üòç", "üò¢", "üò°", "ü§£", "üòú", "üôè", "üí™"
            ],
            smileys: [
                "üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "ü§£", "üòÇ", "üôÇ", "üôÉ",
                "üòâ", "üòä", "üòá", "ü•∞", "üòç", "ü§©", "üòò", "üòó", "üòö", "üòô",
                "üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ë", "ü§ó", "ü§≠", "ü§´", "ü§î",
                "ü§ê", "ü§®", "üòê", "üòë", "üò∂", "üòè", "üòí", "üôÑ", "üò¨", "ü§•",
                "üòå", "üòî", "üò™", "ü§§", "üò¥", "üò∑", "ü§í", "ü§ï", "ü§¢", "ü§Æ",
                "ü§ß", "ü•µ", "ü•∂", "ü•¥", "üòµ", "ü§Ø", "ü§†", "ü•≥", "üòé", "ü§ì",
                "üßê", "üòï", "üòü", "üôÅ", "üòÆ", "üòØ", "üò≤", "üò≥", "ü•∫", "üò¶",
                "üòß", "üò®", "üò∞", "üò•", "üò¢", "üò≠", "üò±", "üòñ", "üò£", "üòû",
                "üòì", "üò©", "üò´", "ü•±", "üò§", "üò°", "üò†", "ü§¨", "üòà", "üëø"
            ],
            people: [
                "üë∂", "üßí", "üë¶", "üëß", "üßë", "üë®", "üë©", "üßî", "üë®‚Äçü¶∞", "üë©‚Äçü¶∞",
                "üë®‚Äçü¶±", "üë©‚Äçü¶±", "üë®‚Äçü¶≥", "üë©‚Äçü¶≥", "üë®‚Äçü¶≤", "üë©‚Äçü¶≤", "üë±", "üë±‚Äç‚ôÇÔ∏è", "üë±‚Äç‚ôÄÔ∏è", "üßì",
                "üë¥", "üëµ", "üôç", "üôç‚Äç‚ôÇÔ∏è", "üôç‚Äç‚ôÄÔ∏è", "üôé", "üôé‚Äç‚ôÇÔ∏è", "üôé‚Äç‚ôÄÔ∏è", "üôÖ", "üôÖ‚Äç‚ôÇÔ∏è",
                "üôÖ‚Äç‚ôÄÔ∏è", "üôÜ", "üôÜ‚Äç‚ôÇÔ∏è", "üôÜ‚Äç‚ôÄÔ∏è", "üíÅ", "üíÅ‚Äç‚ôÇÔ∏è", "üíÅ‚Äç‚ôÄÔ∏è", "üôã", "üôã‚Äç‚ôÇÔ∏è", "üôã‚Äç‚ôÄÔ∏è",
                "üôá", "üôá‚Äç‚ôÇÔ∏è", "üôá‚Äç‚ôÄÔ∏è", "ü§¶", "ü§¶‚Äç‚ôÇÔ∏è", "ü§¶‚Äç‚ôÄÔ∏è", "ü§∑", "ü§∑‚Äç‚ôÇÔ∏è", "ü§∑‚Äç‚ôÄÔ∏è", "üë®‚Äç‚öïÔ∏è",
                "üë©‚Äç‚öïÔ∏è", "üë®‚Äçüéì", "üë©‚Äçüéì", "üë®‚Äçüè´", "üë©‚Äçüè´", "üë®‚Äç‚öñÔ∏è", "üë©‚Äç‚öñÔ∏è", "üë®‚Äçüåæ", "üë©‚Äçüåæ", "üë®‚Äçüç≥",
                "üë©‚Äçüç≥", "üë®‚Äçüîß", "üë©‚Äçüîß", "üë®‚Äçüè≠", "üë©‚Äçüè≠", "üë®‚Äçüíº", "üë©‚Äçüíº", "üë®‚Äçüî¨", "üë©‚Äçüî¨", "üë®‚Äçüíª",
                "üë©‚Äçüíª", "üë®‚Äçüé§", "üë©‚Äçüé§", "üë®‚Äçüé®", "üë©‚Äçüé®", "üë®‚Äç‚úàÔ∏è", "üë©‚Äç‚úàÔ∏è", "üë®‚ÄçüöÄ", "üë©‚ÄçüöÄ", "üë®‚Äçüöí",
                "üë©‚Äçüöí", "üëÆ", "üëÆ‚Äç‚ôÇÔ∏è", "üëÆ‚Äç‚ôÄÔ∏è", "üïµÔ∏è", "üïµÔ∏è‚Äç‚ôÇÔ∏è", "üïµÔ∏è‚Äç‚ôÄÔ∏è", "üíÇ", "üíÇ‚Äç‚ôÇÔ∏è", "üíÇ‚Äç‚ôÄÔ∏è"
            ],
            animals: [
                "üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ",
                "ü¶Å", "üêÆ", "üê∑", "üêΩ", "üê∏", "üêµ", "üôà", "üôâ", "üôä", "üêí",
                "üêî", "üêß", "üê¶", "üê§", "üê£", "üê•", "ü¶Ü", "ü¶Ö", "ü¶â", "ü¶á",
                "üê∫", "üêó", "üê¥", "ü¶Ñ", "üêù", "üêõ", "ü¶ã", "üêå", "üêû", "üêú",
                "ü¶ü", "ü¶ó", "üï∑Ô∏è", "üï∏Ô∏è", "ü¶Ç", "üê¢", "üêç", "ü¶é", "ü¶ñ", "ü¶ï",
                "üêô", "ü¶ë", "ü¶ê", "ü¶û", "ü¶Ä", "üê°", "üê†", "üêü", "üê¨", "üê≥",
                "üêã", "ü¶à", "üêä", "üêÖ", "üêÜ", "ü¶ì", "ü¶ç", "ü¶ß", "üêò", "ü¶õ",
                "ü¶è", "üê™", "üê´", "ü¶í", "ü¶ò", "üêÉ", "üêÇ", "üêÑ", "üêé", "üêñ",
                "üêè", "üêë", "ü¶ô", "üêê", "ü¶å", "üêï", "üê©", "ü¶Æ", "üêï‚Äçü¶∫", "üêà"
            ],
            food: [
                "üçè", "üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "ü´ê",
                "üçà", "üçí", "üçë", "ü•≠", "üçç", "ü••", "ü•ù", "üçÖ", "üçÜ", "ü•ë",
                "ü•¶", "ü•¨", "ü•í", "üå∂Ô∏è", "ü´ë", "üåΩ", "ü•ï", "ü´í", "üßÑ", "üßÖ",
                "ü•î", "üç†", "ü´ò", "ü•ê", "ü•Ø", "üçû", "ü•ñ", "ü•®", "üßÄ", "ü•ö",
                "üç≥", "üßà", "ü•û", "üßá", "ü•ì", "ü•©", "üçó", "üçñ", "ü¶¥", "üå≠",
                "üçî", "üçü", "üçï", "ü´ì", "ü•™", "ü•ô", "üßÜ", "üåÆ", "üåØ", "ü´î",
                "ü•ó", "ü•ò", "ü´ï", "ü•´", "üçù", "üçú", "üç≤", "üçõ", "üç£", "üç±",
                "ü•ü", "ü¶™", "üç§", "üçô", "üçö", "üçò", "üç•", "ü•†", "ü•Æ", "üç¢",
                "üç°", "üçß", "üç®", "üç¶", "ü•ß", "üßÅ", "üç∞", "üéÇ", "üçÆ", "üç≠"
            ],
            activities: [
                "‚öΩ", "üèÄ", "üèà", "‚öæ", "ü•é", "üéæ", "üèê", "üèâ", "ü•è", "üé±",
                "ü™Ä", "üèì", "üè∏", "üèí", "üèë", "ü•ç", "üèè", "ü™É", "ü•Ö", "‚õ≥",
                "ü™Å", "üèπ", "üé£", "ü§ø", "ü•ä", "ü•ã", "üéΩ", "üõπ", "üõº", "üõ∑",
                "‚õ∏Ô∏è", "ü•å", "üéø", "‚õ∑Ô∏è", "üèÇ", "ü™Ç", "üèãÔ∏è", "üèãÔ∏è‚Äç‚ôÇÔ∏è", "üèãÔ∏è‚Äç‚ôÄÔ∏è", "ü§º",
                "ü§º‚Äç‚ôÇÔ∏è", "ü§º‚Äç‚ôÄÔ∏è", "ü§∏", "ü§∏‚Äç‚ôÇÔ∏è", "ü§∏‚Äç‚ôÄÔ∏è", "ü§∫", "ü§æ", "ü§æ‚Äç‚ôÇÔ∏è", "ü§æ‚Äç‚ôÄÔ∏è", "üèåÔ∏è",
                "üèåÔ∏è‚Äç‚ôÇÔ∏è", "üèåÔ∏è‚Äç‚ôÄÔ∏è", "üèá", "üßò", "üßò‚Äç‚ôÇÔ∏è", "üßò‚Äç‚ôÄÔ∏è", "üèÑ", "üèÑ‚Äç‚ôÇÔ∏è", "üèÑ‚Äç‚ôÄÔ∏è", "üèä",
                "üèä‚Äç‚ôÇÔ∏è", "üèä‚Äç‚ôÄÔ∏è", "ü§Ω", "ü§Ω‚Äç‚ôÇÔ∏è", "ü§Ω‚Äç‚ôÄÔ∏è", "üö£", "üö£‚Äç‚ôÇÔ∏è", "üö£‚Äç‚ôÄÔ∏è", "üßó", "üßó‚Äç‚ôÇÔ∏è",
                "üßó‚Äç‚ôÄÔ∏è", "üöµ", "üöµ‚Äç‚ôÇÔ∏è", "üöµ‚Äç‚ôÄÔ∏è", "üö¥", "üö¥‚Äç‚ôÇÔ∏è", "üö¥‚Äç‚ôÄÔ∏è", "üèÜ", "ü•á", "ü•à",
                "ü•â", "üèÖ", "üéñÔ∏è", "üèµÔ∏è", "üéóÔ∏è", "üé´", "üéüÔ∏è", "üé™", "ü§π", "ü§π‚Äç‚ôÇÔ∏è"
            ],
            travel: [
                "üöó", "üöï", "üöô", "üöå", "üöé", "üèéÔ∏è", "üöì", "üöë", "üöí", "üöê",
                "üõª", "üöö", "üöõ", "üöú", "ü¶Ø", "ü¶Ω", "ü¶º", "üõ¥", "üö≤", "üõµ",
                "üèçÔ∏è", "üõ∫", "üö®", "üöî", "üöç", "üöò", "üöñ", "üö°", "üö†", "üöü",
                "üöÉ", "üöã", "üöû", "üöù", "üöÑ", "üöÖ", "üöà", "üöÇ", "üöÜ", "üöá",
                "üöä", "üöâ", "‚úàÔ∏è", "üõ´", "üõ¨", "üõ©Ô∏è", "üí∫", "üõ∞Ô∏è", "üöÄ", "üõ∏",
                "üöÅ", "üõ∂", "‚õµ", "üö§", "üõ•Ô∏è", "üõ≥Ô∏è", "‚õ¥Ô∏è", "üö¢", "‚öì", "ü™ù",
                "üåç", "üåé", "üåè", "üó∫Ô∏è", "üóæ", "üß≠", "üèîÔ∏è", "‚õ∞Ô∏è", "üåã", "üóª",
                "üèïÔ∏è", "üèñÔ∏è", "üèúÔ∏è", "üèùÔ∏è", "üèûÔ∏è", "üèüÔ∏è", "üèõÔ∏è", "üèóÔ∏è", "üß±", "ü™®"
            ],
            objects: [
                "üíé", "üî™", "üè∫", "üóø", "ü™ô", "üí∞", "üí¥", "üíµ", "üí∂", "üí∑",
                "üí∏", "üí≥", "üßæ", "‚úâÔ∏è", "üìß", "üì®", "üì©", "üì§", "üì•", "üì¶",
                "üì´", "üì™", "üì¨", "üì≠", "üìÆ", "üó≥Ô∏è", "‚úèÔ∏è", "‚úíÔ∏è", "üñãÔ∏è", "üñäÔ∏è",
                "üñåÔ∏è", "üñçÔ∏è", "üìù", "üíº", "üìÅ", "üìÇ", "üóÇÔ∏è", "üìÖ", "üìÜ", "üóíÔ∏è",
                "üìä", "üìà", "üìâ", "üìã", "üìå", "üìç", "üìé", "üñáÔ∏è", "üìè", "üìê",
                "‚úÇÔ∏è", "üóÉÔ∏è", "üóÑÔ∏è", "üóëÔ∏è", "üîí", "üîì", "üîè", "üîê", "üîë", "üóùÔ∏è",
                "üî®", "ü™ì", "‚õèÔ∏è", "‚öíÔ∏è", "üõ†Ô∏è", "üó°Ô∏è", "‚öîÔ∏è", "üî´", "üèπ", "üõ°Ô∏è",
                "üîß", "üî©", "‚öôÔ∏è", "üóúÔ∏è", "‚öñÔ∏è", "ü¶Ø", "üîó", "‚õìÔ∏è", "üß∞", "üß≤"
            ],
            symbols: [
                "‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî",
                "‚ù£Ô∏è", "üíï", "üíû", "üíì", "üíó", "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è",
                "‚úùÔ∏è", "‚ò™Ô∏è", "üïâÔ∏è", "‚ò∏Ô∏è", "‚ú°Ô∏è", "üîØ", "üïé", "‚òØÔ∏è", "‚ò¶Ô∏è", "üõê",
                "‚õé", "‚ôà", "‚ôâ", "‚ôä", "‚ôã", "‚ôå", "‚ôç", "‚ôé", "‚ôè", "‚ôê",
                "‚ôë", "‚ôí", "‚ôì", "üÜî", "‚öõÔ∏è", "üâë", "‚ò¢Ô∏è", "‚ò£Ô∏è", "üì¥", "üì≥",
                "üà∂", "üàö", "üà∏", "üà∫", "üà∑Ô∏è", "‚ú¥Ô∏è", "üÜö", "üíÆ", "üâê", "„äôÔ∏è",
                "„äóÔ∏è", "üà¥", "üàµ", "üàπ", "üà≤", "üÖ∞Ô∏è", "üÖ±Ô∏è", "üÜé", "üÜë", "üÖæÔ∏è",
                "üÜò", "‚ùå", "‚≠ï", "üõë", "‚õî", "üìõ", "üö´", "üíØ", "üí¢", "‚ô®Ô∏è"
            ],
            flags: [
                "üèÅ", "üö©", "üéå", "üè¥", "üè≥Ô∏è", "üè≥Ô∏è‚Äçüåà", "üè≥Ô∏è‚Äç‚ößÔ∏è", "üè¥‚Äç‚ò†Ô∏è", "üá¶üá´", "üá¶üáΩ",
                "üá¶üá±", "üá©üáø", "üá¶üá∏", "üá¶üá©", "üá¶üá¥", "üá¶üá∞", "üá¶üáÆ", "üá¶üá∂", "üá¶üá¨", "üá¶üá∑",
                "üá¶üá≤", "üá¶üáº", "üá¶üá∫", "üá¶üáπ", "üá¶üáø", "üáßüá∏", "üáßüá≠", "üáßüá©", "üáßüáß", "üáßüáæ",
                "üáßüá™", "üáßüáø", "üáßüáØ", "üáßüá≤", "üáßüáπ", "üáßüá¥", "üáßüá¶", "üáßüáº", "üáßüá∑", "üáÆüá¥",
                "üáªüá¨", "üáßüá≥", "üáßüá¨", "üáßüá´", "üáßüáÆ", "üá∞üá≠", "üá®üá≤", "üá®üá¶", "üáÆüá®", "üá®üáª",
                "üáßüá∂", "üá∞üáæ", "üá®üá´", "üáπüá©", "üá®üá±", "üá®üá≥", "üá®üáΩ", "üá®üá®", "üá®üá¥", "üá∞üá≤",
                "üá®üá¨", "üá®üá©", "üá®üá∞", "üá®üá∑", "üá®üáÆ", "üá≠üá∑", "üá®üá∫", "üá®üáº", "üá®üáæ", "üá®üáø",
                "üá©üá∞", "üá©üáØ", "üá©üá≤", "üá©üá¥", "üá™üá®", "üá™üá¨", "üá∏üáª", "üá¨üá∂", "üá™üá∑", "üá™üá™",
                "üá™üáπ", "üá™üá∫", "üá´üá∞", "üá´üá¥", "üá´üáØ", "üá´üáÆ", "üá´üá∑", "üá¨üá´", "üáµüá´", "üáπüá´"
            ]
        };
        
        function initEmojiPanel() {
            const categoriesContainer = document.getElementById('emojiCategories');
            const gridContainer = document.getElementById('emojiGrid');
            
            emojiCategories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'emoji-category';
                btn.textContent = category.title;
                btn.dataset.category = category.name;
                btn.addEventListener('click', () => showEmojiCategory(category.name));
                categoriesContainer.appendChild(btn);
            });
            
            showEmojiCategory('popular');
            
            document.getElementById('emojiButton').addEventListener('click', toggleEmojiPanel);
            document.querySelector('.private-emoji-btn').addEventListener('click', toggleEmojiPanel);
            
            document.addEventListener('click', (e) => {
                const emojiPanel = document.getElementById('emojiPanel');
                const emojiBtn = document.getElementById('emojiButton');
                const privateEmojiBtn = document.querySelector('.private-emoji-btn');
                
                if (emojiPanel.style.display === 'flex' && 
                    !emojiPanel.contains(e.target) && 
                    !emojiBtn.contains(e.target) &&
                    !privateEmojiBtn.contains(e.target)) {
                    emojiPanel.style.display = 'none';
                    emojiPanelVisible = false;
                }
            });
        }
        
        function showEmojiCategory(categoryName) {
            const gridContainer = document.getElementById('emojiGrid');
            const categoryButtons = document.querySelectorAll('.emoji-category');
            
            categoryButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === categoryName);
            });
            
            gridContainer.innerHTML = '';
            
            emojis[categoryName].forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => insertEmoji(emoji));
                gridContainer.appendChild(emojiItem);
            });
        }
        
        function toggleEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanelVisible = !emojiPanelVisible;
            emojiPanel.style.display = emojiPanelVisible ? 'flex' : 'none';
        }
        
        function insertEmoji(emoji) {
            const activeInput = currentPrivateChat ? 
                document.getElementById('privateMessageInput') : 
                document.getElementById('messageInput');
            
            const start = activeInput.selectionStart;
            const end = activeInput.selectionEnd;
            const text = activeInput.value;
            
            activeInput.value = text.substring(0, start) + emoji + text.substring(end);
            activeInput.focus();
            activeInput.selectionStart = activeInput.selectionEnd = start + emoji.length;
        }
        
        // ============ –ü–û–ò–°–ö ============
        function initSearch() {
            // –ö–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
            document.getElementById('searchPublicBtn').addEventListener('click', () => {
                showSearch('public');
            });
            
            document.getElementById('searchUsersBtn').addEventListener('click', () => {
                showSearch('users');
            });
            
            document.getElementById('searchPrivateBtn').addEventListener('click', () => {
                showSearch('private');
            });
            
            // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞
            document.getElementById('closeSearch').addEventListener('click', hideSearch);
            document.getElementById('closeUsersSearch').addEventListener('click', hideSearch);
            document.getElementById('closePrivateSearch').addEventListener('click', hideSearch);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞ –ø–æ–∏—Å–∫–∞
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchMessages(e.target.value, 'public');
            });
            
            document.getElementById('searchUsersInput').addEventListener('input', (e) => {
                searchUsers(e.target.value);
            });
            
            document.getElementById('searchPrivateInput').addEventListener('input', (e) => {
                searchMessages(e.target.value, 'private');
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isSearching) {
                    hideSearch();
                }
            });
        }
        
        function showSearch(type) {
            isSearching = true;
            
            if (type === 'public') {
                document.getElementById('searchContainer').style.display = 'flex';
                document.getElementById('searchInput').focus();
            } else if (type === 'users') {
                document.getElementById('usersSearchContainer').style.display = 'flex';
                document.getElementById('searchUsersInput').focus();
            } else if (type === 'private') {
                document.getElementById('privateSearchContainer').style.display = 'flex';
                document.getElementById('searchPrivateInput').focus();
            }
        }
        
        function hideSearch() {
            isSearching = false;
            searchQuery = '';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('usersSearchContainer').style.display = 'none';
            document.getElementById('privateSearchContainer').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
            document.getElementById('searchInput').value = '';
            document.getElementById('searchUsersInput').value = '';
            document.getElementById('searchPrivateInput').value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (currentPrivateChat) {
                displayPrivateMessages(currentPrivateMessages);
            } else {
                displayPublicMessages(allPublicMessages);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            loadUsersList();
        }
        
        function searchMessages(query, type) {
            searchQuery = query.toLowerCase();
            
            if (!query.trim()) {
                if (type === 'public') {
                    displayPublicMessages(allPublicMessages);
                } else {
                    displayPrivateMessages(currentPrivateMessages);
                }
                return;
            }
            
            if (type === 'public') {
                const filtered = allPublicMessages.filter(msg => {
                    if (msg.type === 'voice' || msg.type === 'photo') return false;
                    return msg.text && msg.text.toLowerCase().includes(searchQuery);
                });
                displayPublicMessages(filtered, true);
            } else {
                const filtered = currentPrivateMessages.filter(msg => {
                    if (msg.type === 'voice' || msg.type === 'photo') return false;
                    return msg.text && msg.text.toLowerCase().includes(searchQuery);
                });
                displayPrivateMessages(filtered, true);
            }
        }
        
        function searchUsers(query) {
            const usersList = document.getElementById('usersList');
            const userItems = usersList.querySelectorAll('.user-item');
            
            userItems.forEach(item => {
                const userName = item.querySelector('.user-name').textContent.toLowerCase();
                if (userName.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function highlightText(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-result-highlight">$1</span>');
        }
        
        // ============ –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ============
        function initVoiceMessages() {
            const voiceButton = document.getElementById('voiceButton');
            const privateVoiceButton = document.querySelector('.private-voice-btn');
            const recordingIndicator = document.getElementById('recordingIndicator');
            
            voiceButton.addEventListener('mousedown', startRecording);
            voiceButton.addEventListener('mouseup', stopRecording);
            voiceButton.addEventListener('mouseleave', stopRecording);
            
            privateVoiceButton.addEventListener('mousedown', startRecording);
            privateVoiceButton.addEventListener('mouseup', stopRecording);
            privateVoiceButton.addEventListener('mouseleave', stopRecording);
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadAndSendVoiceMessage(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('voiceButton').classList.add('recording');
                document.getElementById('recordingIndicator').classList.add('active');
                document.querySelector('.private-voice-btn').classList.add('recording');
                document.querySelector('.private-recording-indicator').classList.add('active');
                
                showNotification('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞...');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', err);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                document.getElementById('voiceButton').classList.remove('recording');
                document.getElementById('recordingIndicator').classList.remove('active');
                document.querySelector('.private-voice-btn').classList.remove('recording');
                document.querySelector('.private-recording-indicator').classList.remove('active');
                
                showNotification('–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º...');
            }
        }
        
        async function uploadAndSendVoiceMessage(audioBlob) {
            try {
                const fileName = `voice_${userId}_${Date.now()}.webm`;
                const storageRef = storage.ref(`voice_messages/${fileName}`);
                
                const snapshot = await storageRef.put(audioBlob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                const message = {
                    type: 'voice',
                    url: downloadURL,
                    duration: Math.round(audioBlob.size / 16000),
                    user: userName,
                    userId: userId,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    timestamp: Date.now()
                };
                
                if (currentPrivateChat) {
                    const chatId = getChatId(userId, currentPrivateChat);
                    message.to = currentPrivateChat;
                    message.from = userId;
                    message.fromName = userName;
                    database.ref('private_messages/' + chatId).push(message);
                } else {
                    database.ref('messages/public').push(message);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }
        
        function createVoiceMessageElement(message) {
            const voiceDiv = document.createElement('div');
            voiceDiv.className = 'voice-message';
            
            voiceDiv.innerHTML = `
                <div class="voice-player">
                    <button class="voice-play-btn" onclick="playVoiceMessage('${message.url}', this)">‚ñ∂Ô∏è</button>
                    <div class="voice-progress">
                        <div class="voice-progress-bar" id="progress-${message.timestamp}"></div>
                    </div>
                    <div class="voice-duration">${message.duration || '0'}—Å</div>
                </div>
                <div style="font-size: 12px; color: #666;">
                    ${message.fromName || message.user}
                </div>
            `;
            
            return voiceDiv;
        }
        
        function playVoiceMessage(url, button) {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio = null;
                button.innerHTML = '‚ñ∂Ô∏è';
                return;
            }
            
            currentAudio = new Audio(url);
            const progressBar = button.parentElement.querySelector('.voice-progress-bar');
            
            currentAudio.addEventListener('timeupdate', () => {
                const percent = (currentAudio.currentTime / currentAudio.duration) * 100;
                progressBar.style.width = percent + '%';
            });
            
            currentAudio.addEventListener('ended', () => {
                button.innerHTML = '‚ñ∂Ô∏è';
                progressBar.style.width = '0%';
                currentAudio = null;
            });
            
            currentAudio.play();
            button.innerHTML = '‚è∏Ô∏è';
        }
        
        // ============ –§–û–¢–û –°–û–û–ë–©–ï–ù–ò–Ø ============
        function initPhotoUpload() {
            const photoButton = document.getElementById('photoButton');
            const privatePhotoButton = document.querySelector('.private-photo-btn');
            const photoInput = document.getElementById('photoInput');
            
            photoButton.addEventListener('click', () => {
                photoInput.click();
            });
            
            privatePhotoButton.addEventListener('click', () => {
                photoInput.click();
            });
            
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 10MB');
                    return;
                }
                
                await uploadAndSendPhoto(file);
                photoInput.value = '';
            });
        }
        
        async function uploadAndSendPhoto(file) {
            try {
                showNotification('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
                
                const fileName = `photo_${userId}_${Date.now()}_${file.name}`;
                const storageRef = storage.ref(`photos/${fileName}`);
                
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                const thumbURL = await createThumbnail(file);
                
                const message = {
                    type: 'photo',
                    url: downloadURL,
                    thumbnail: thumbURL,
                    fileName: file.name,
                    fileSize: Math.round(file.size / 1024) + 'KB',
                    user: userName,
                    userId: userId,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    timestamp: Date.now()
                };
                
                if (currentPrivateChat) {
                    const chatId = getChatId(userId, currentPrivateChat);
                    message.to = currentPrivateChat;
                    message.from = userId;
                    message.fromName = userName;
                    database.ref('private_messages/' + chatId).push(message);
                } else {
                    database.ref('messages/public').push(message);
                }
                
                showNotification('–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ');
            }
        }
        
        function createThumbnail(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxSize = 200;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function createPhotoMessageElement(message) {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-message';
            
            photoDiv.innerHTML = `
                <img src="${message.thumbnail || message.url}" 
                     onclick="openFullPhoto('${message.url}')" 
                     style="cursor: pointer;"
                     loading="lazy">
                <div style="padding: 8px; font-size: 12px; color: #666;">
                    <div>${message.fromName || message.user}</div>
                    <div>${message.fileSize || ''}</div>
                </div>
            `;
            
            return photoDiv;
        }
        
        function openFullPhoto(url) {
            document.getElementById('fullPhoto').src = url;
            document.getElementById('photoModal').style.display = 'flex';
        }
        
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // ============ –†–ï–ê–ö–¶–ò–ò ============
        function initReactions() {
            const reactionPicker = document.getElementById('reactionPicker');
            const popularReactions = ['‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üëè', 'üî•', 'üëç', 'üëé'];
            
            popularReactions.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'reaction-emoji';
                div.textContent = emoji;
                div.onclick = () => addReaction(currentReactionMessage, emoji);
                reactionPicker.appendChild(div);
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.add-reaction-btn') && !e.target.closest('.reaction-picker')) {
                    reactionPicker.style.display = 'none';
                }
            });
        }
        
        let currentReactionMessage = null;
        
        function showReactionPicker(messageId, x, y) {
            const picker = document.getElementById('reactionPicker');
            picker.style.display = 'grid';
            picker.style.left = x + 'px';
            picker.style.top = y + 'px';
            currentReactionMessage = messageId;
        }
        
        async function addReaction(messageId, emoji) {
            const reactionRef = database.ref(`reactions/${messageId}/${userId}`);
            await reactionRef.set(emoji);
            
            document.getElementById('reactionPicker').style.display = 'none';
        }
        
        function loadReactions(messageId, container) {
            const reactionsRef = database.ref(`reactions/${messageId}`);
            
            reactionsRef.on('value', (snapshot) => {
                const reactions = snapshot.val() || {};
                const reactionsDiv = container.querySelector('.message-reactions') || 
                                   document.createElement('div');
                
                if (!container.querySelector('.message-reactions')) {
                    reactionsDiv.className = 'message-reactions';
                    container.appendChild(reactionsDiv);
                }
                
                reactionsDiv.innerHTML = '';
                
                const grouped = {};
                Object.entries(reactions).forEach(([uid, emoji]) => {
                    grouped[emoji] = (grouped[emoji] || 0) + 1;
                });
                
                Object.entries(grouped).forEach(([emoji, count]) => {
                    const isMyReaction = reactions[userId] === emoji;
                    const btn = document.createElement('button');
                    btn.className = `reaction-btn ${isMyReaction ? 'active' : ''}`;
                    btn.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
                    btn.onclick = () => toggleReaction(messageId, emoji);
                    reactionsDiv.appendChild(btn);
                });
                
                const addBtn = document.createElement('button');
                addBtn.className = 'add-reaction-btn';
                addBtn.innerHTML = '+';
                addBtn.onclick = (e) => {
                    const rect = e.target.getBoundingClientRect();
                    showReactionPicker(messageId, rect.left, rect.bottom + 10);
                };
                reactionsDiv.appendChild(addBtn);
            });
        }
        
        async function toggleReaction(messageId, emoji) {
            const reactionRef = database.ref(`reactions/${messageId}/${userId}`);
            const snapshot = await reactionRef.once('value');
            
            if (snapshot.val() === emoji) {
                await reactionRef.remove();
            } else {
                await reactionRef.set(emoji);
            }
        }
        
        // ============ –û–ë–©–ò–ô –ß–ê–¢ ============
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            const newName = document.getElementById('nameInput').value.trim() || '–ì–æ—Å—Ç—å';
            if (newName !== userName) {
                userName = newName;
                localStorage.setItem('chat_name', userName);
                updateUserInfo();
                showNotification('–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ' + userName);
            }
            
            const message = {
                text: messageText,
                user: userName,
                userId: userId,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'text'
            };
            
            database.ref('messages/public').push(message);
            messageInput.value = '';
            messageInput.focus();
            
            document.getElementById('emojiPanel').style.display = 'none';
            emojiPanelVisible = false;
        }
        
        function addMessageToUI(message, isOwn = false) {
            allPublicMessages.push(message);
            
            if (isSearching && searchQuery) {
                if (message.type === 'text' && message.text.toLowerCase().includes(searchQuery)) {
                    displayPublicMessages(allPublicMessages.filter(m => 
                        m.type === 'text' && m.text.toLowerCase().includes(searchQuery)
                    ), true);
                }
            } else {
                displayPublicMessages([message], false, true);
            }
            
            if (message.userId !== userId && document.hidden) {
                unreadPublic++;
                updateUnreadBadges();
                showBrowserNotification(
                    message.user,
                    message.text.substring(0, 50),
                    'new_message'
                );
            }
        }
        
        function displayPublicMessages(messages, highlight = false, append = false) {
            const container = document.getElementById('messagesContainer');
            
            if (!append) {
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                            <h3>–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞</p>
                        </div>
                    `;
                    return;
                }
            }
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                const isOurMessage = message.userId === userId;
                
                const messageId = `msg_${message.timestamp}_${message.userId}`;
                messageDiv.className = `message ${isOurMessage ? 'outgoing' : 'incoming'}`;
                messageDiv.dataset.messageId = messageId;
                
                let content = '';
                
                if (message.type === 'voice') {
                    content = createVoiceMessageElement(message).outerHTML;
                } else if (message.type === 'photo') {
                    content = createPhotoMessageElement(message).outerHTML;
                } else {
                    const displayText = highlight ? highlightText(message.text, searchQuery) : message.text;
                    content = `
                        <div class="message-bubble">
                            <div class="message-user">
                                ${isOurMessage ? '–í—ã' : message.user}
                            </div>
                            <div class="message-text">${displayText}</div>
                            <div class="message-time">${message.time}</div>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = content;
                container.appendChild(messageDiv);
                
                if (message.type === 'text') {
                    loadReactions(messageId, messageDiv);
                }
            });
            
            if (!append) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // ============ –õ–ò–ß–ù–´–ï –ß–ê–¢–´ ============
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            const searchQuery = document.getElementById('searchUsersInput').value.toLowerCase();
            
            usersList.innerHTML = '';
            
            let onlineCount = 0;
            let hasUsers = false;
            
            Object.keys(onlineUsers).forEach(otherUserId => {
                if (otherUserId === userId) return;
                
                const user = onlineUsers[otherUserId];
                const isOnline = user.online && (Date.now() - user.lastSeen < 30000);
                
                if (!isOnline) return;
                
                onlineCount++;
                
                if (searchQuery && !user.name.toLowerCase().includes(searchQuery)) {
                    return;
                }
                
                hasUsers = true;
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.userId = otherUserId;
                
                const firstLetter = user.name.charAt(0).toUpperCase();
                
                userItem.innerHTML = `
                    <div class="user-avatar">${firstLetter}</div>
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <div class="user-status">
                            <span class="online-dot" style="width: 6px; height: 6px; background: ${isOnline ? '#00ff88' : '#999'}"></span>
                            ${isOnline ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ—Ñ–ª–∞–π–Ω'}
                        </div>
                    </div>
                `;
                
                userItem.addEventListener('click', () => openPrivateChat(otherUserId, user.name));
                usersList.appendChild(userItem);
            });
            
            document.getElementById('privateOnlineCount').textContent = onlineCount;
            
            if (!hasUsers) {
                usersList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">
                            ${searchQuery ? 'üîç' : 'üë§'}
                        </div>
                        <h3>${searchQuery ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' : '–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'}</h3>
                        <p>${searchQuery ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞' : '–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É'}</p>
                    </div>
                `;
            }
        }
        
        function openPrivateChat(otherUserId, otherUserName) {
            currentPrivateChat = otherUserId;
            
            document.getElementById('privateChats').style.display = 'none';
            document.getElementById('privateMessages').style.display = 'flex';
            
            document.getElementById('privateChatWith').textContent = otherUserName;
            
            loadPrivateMessages(otherUserId);
            
            document.getElementById('privateMessageInput').focus();
            
            unreadPrivate = 0;
            updateUnreadBadges();
        }
        
        function loadPrivateMessages(otherUserId) {
            const chatId = getChatId(userId, otherUserId);
            const container = document.getElementById('privateMessagesContainer');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            if (!allPrivateMessages[chatId]) {
                allPrivateMessages[chatId] = [];
            }
            
            database.ref('private_messages/' + chatId).limitToLast(100).on('value', (snapshot) => {
                const messages = snapshot.val();
                allPrivateMessages[chatId] = [];
                currentPrivateMessages = [];
                
                if (messages) {
                    Object.values(messages).forEach(msg => {
                        allPrivateMessages[chatId].push(msg);
                        currentPrivateMessages.push(msg);
                    });
                }
                
                displayPrivateMessages(currentPrivateMessages);
            });
        }
        
        function displayPrivateMessages(messages, highlight = false) {
            const container = document.getElementById('privateMessagesContainer');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                        <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                const isOurMessage = message.from === userId;
                
                const messageId = `private_${message.timestamp}_${message.from}`;
                messageDiv.className = `message ${isOurMessage ? 'outgoing' : 'incoming'}`;
                messageDiv.dataset.messageId = messageId;
                
                let content = '';
                
                if (message.type === 'voice') {
                    content = createVoiceMessageElement(message).outerHTML;
                } else if (message.type === 'photo') {
                    content = createPhotoMessageElement(message).outerHTML;
                } else {
                    const displayText = highlight ? highlightText(message.text, searchQuery) : message.text;
                    content = `
                        <div class="message-bubble">
                            <div class="message-user">
                                ${isOurMessage ? '–í—ã' : message.fromName}
                            </div>
                            <div class="message-text">${displayText}</div>
                            <div class="message-time">${message.time}</div>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = content;
                container.appendChild(messageDiv);
                
                if (!message.type || message.type === 'text') {
                    loadReactions(messageId, messageDiv);
                }
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function sendPrivateMessage() {
            if (!currentPrivateChat) return;
            
            const input = document.getElementById('privateMessageInput');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            const chatId = getChatId(userId, currentPrivateChat);
            const message = {
                text: messageText,
                from: userId,
                to: currentPrivateChat,
                fromName: userName,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'text'
            };
            
            database.ref('private_messages/' + chatId).push(message);
            input.value = '';
            input.focus();
            
            document.getElementById('emojiPanel').style.display = 'none';
            emojiPanelVisible = false;
        }
        
        function getChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }
        
        // ============ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ë–†–ê–£–ó–ï–†–ê ============
        function initBrowserNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function showBrowserNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (document.hidden) {
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png',
                        tag: 'chat',
                        requireInteraction: true
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        this.close();
                    };
                    
                    setTimeout(() => notification.close(), 5000);
                }
            }
        }
        
        // ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–ê–î–ö–ê–ú–ò ============
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    if (tabName === 'public') {
                        unreadPublic = 0;
                    } else if (tabName === 'private') {
                        unreadPrivate = 0;
                    }
                    updateUnreadBadges();
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.getElementById('publicChat').style.display = tabName === 'public' ? 'flex' : 'none';
                    document.getElementById('privateChats').style.display = tabName === 'private' ? 'flex' : 'none';
                    document.getElementById('privateMessages').style.display = 'none';
                    
                    currentPrivateChat = null;
                    
                    document.getElementById('emojiPanel').style.display = 'none';
                    emojiPanelVisible = false;
                    
                    if (tabName === 'private') {
                        loadUsersList();
                    }
                });
            });
            
            document.getElementById('backToUsers').addEventListener('click', () => {
                document.getElementById('privateMessages').style.display = 'none';
                document.getElementById('privateChats').style.display = 'flex';
                currentPrivateChat = null;
            });
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        document.addEventListener('DOMContentLoaded', () => {
            initEmojiPanel();
            initTabs();
            initSearch();
            initVoiceMessages();
            initPhotoUpload();
            initReactions();
            initBrowserNotifications();
            
            document.getElementById('nameInput').value = userName;
            document.getElementById('nameInput').addEventListener('change', updateUserName);
            
            userStatusRef = database.ref('online_users/' + userId);
            
            userStatusRef.set({
                name: userName,
                online: true,
                lastSeen: Date.now()
            });
            
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('privateSendButton').addEventListener('click', sendPrivateMessage);
            document.getElementById('privateMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            database.ref('messages/public').orderByChild('timestamp').limitToLast(100).on('child_added', (snapshot) => {
                addMessageToUI(snapshot.val());
            });
            
            database.ref('online_users').on('value', (snapshot) => {
                onlineUsers = snapshot.val() || {};
                
                let onlineCount = 0;
                Object.values(onlineUsers).forEach(user => {
                    if (user.online && (Date.now() - user.lastSeen < 30000)) {
                        onlineCount++;
                    }
                });
                document.getElementById('onlineCount').textContent = onlineCount;
                
                if (document.getElementById('privateChats').style.display === 'flex') {
                    loadUsersList();
                }
            });
            
            setInterval(() => {
                userStatusRef.update({ lastSeen: Date.now() });
            }, 10000);
            
            window.addEventListener('beforeunload', () => {
                userStatusRef.update({ online: false });
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    userStatusRef.update({ lastSeen: Date.now() });
                } else {
                    userStatusRef.update({ online: true, lastSeen: Date.now() });
                    unreadPublic = 0;
                    unreadPrivate = 0;
                    updateUnreadBadges();
                }
            });
            
            document.getElementById('messageInput').focus();
        });
    </script>
</body>
</html>